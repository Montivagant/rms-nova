# Repository Audit - 2025-11-08T10:15Z

## Structure & Ownership
- **Apps**: `apps/superadmin` is active and fully aligned with the shared design system; `apps/portal/` now hosts the tenant-facing workspace (dashboard/menu/inventory/POS/payments/reporting, auth middleware, `/api/session` proxy) with an up-to-date README describing run instructions and roadmap.
- **Packages**: Auth, RBAC, module-registry, design-system, and billing shared packages look consistent. Note that module toggle defaults now live in both API and portal (see below).
- **Services**: API/worker layout is orderly; tenant registration schema now lives in migration `002_tenant_registrations`. The worker now hosts the billing webhook BullMQ consumer (transactional processing with queue-held row locks); ensure runtime environments supply `REDIS_URL` and queue settings when promoting. Confirm environments apply the new migrations before deleting legacy artifacts.
- **Generated Artifacts**: `.next/`, `coverage/`, and `test-results/` were lingering locally. `.gitignore` now includes `.next/` and `test-results/` so they cannot be committed (`.gitignore:1-7`).

## Database & Migrations
- `tenant_registrations` now ships via tracked migration (`db/migrations/002_tenant_registrations.up.sql`). Ensure the new migration runs everywhere and remove any remaining references to the old patch script.
- Module toggle defaults are centralised in `packages/module-registry/src/defaults.ts`, eliminating the duplication between API and portal. Monitor other consumers before exposing the export publicly.
- Plans seed via `004_seed_plans_and_entitlements.up.sql`, delivering Core/Pro/Enterprise entitlements for webhook-driven provisioning; apply in every environment before exercising plan-change events (local validation recorded under `tests/drills/logs/local`).

## API Surface
- New endpoints: `PATCH /superadmin/registrations/:id/modules` and the enhanced `POST /superadmin/registrations/:id/decision` persist module presets and seed `tenant_modules`. OpenAPI reflects the changes (`api/openapi-v1.yaml:20-118`); regenerate clients when publishing the SDK.
- `GET /superadmin/billing/summary` now returns upcoming renewal and open invoice slices while exporting Prometheus `nova_api_billing_*` gauges. Companion list endpoints (`/superadmin/billing/renewals`, `/superadmin/billing/open-invoices`) provide paginated detail for the portal.
- `POST /billing/webhooks/sandbox` ingests sandbox payment events (activation, past-due, cancellation, plan-change, invoice lifecycle) with optional shared-secret auth (`BILLING_WEBHOOK_SECRET`), persists payloads to `billing_webhook_events`, and enqueues them for the worker; retries/backoff are handled via BullMQ and every processed outcome now emits `billing.*` audit rows for tenant timelines. Grafana dashboard + alert rules live under `infra/monitoring/` to operationalise the pipeline and monitor retry spikes/backlogs.
- Toggle presets emit audit rows and increment telemetry counters to document module adoption with each change.

## Portal State
- Registrations UI uses optimistic updates for module toggles (`apps/superadmin/components/RegistrationList.tsx:114-255`) and now surfaces inline success messaging after each mutation.
- Customer portal (Next.js app) ships dashboard, menu, inventory, POS, payments, and reporting views that hit `/v1/portal/**` with automatic fallback to the deterministic `@nova/sample-data` kit when a tenant has zero activity; `/login` + middleware guard every route except `/login` + `/api/session`. Documentation under `apps/portal/README.md` now matches the implementation.
- Billing overview now consumes the module toggle analytics endpoint for enable/disable counts, the billing summary API to list upcoming renewals plus open invoices, and links through to dedicated drill-down pages powered by the new list endpoints.
- Billing summary responses also drive Prometheus gauges (`nova_api_billing_*`) for Grafana dashboards and alerting hooks.

## Testing & Tooling
- Unit coverage is ~86% after excluding frontend build artefacts (`vitest.config.ts:17-31`). Keep the high watermark by adding unit coverage as module logic grows.
- `@nova/billing` ships webhook application helpers with direct unit coverage to validate audit writes and queue-facing behaviour.
- API route tests now mock the queue layer to assert persistence and failure handling without requiring Redis; add worker smoke tests once the queue is exercised in integration.
- Integration tests now validate module presets (`tests/integration/superadmin-registrations.test.ts:129-208`) and Playwright asserts UI toggle requests (`tests/e2e/superadmin-registrations.spec.ts:51-108`).
- CI still executes migrations after tests (`.github/workflows/ci.yml:6-84`). Consider running migrations immediately after dependency install to fail faster.

## Clean Development Checklist
- [x] Ignore generated build/test artifacts (`.next/`, `test-results/`).
- [x] Refresh STATUS/TODO/PROGRESS to reflect module toggle work.
- [x] Promote registration schema changes from patch script into tracked migrations.
- [x] Document the tenant-facing `apps/portal/` workspace and keep it in sync with the roadmap.
- [x] Introduce shared source for module toggle defaults.
- [x] Add runbook guidance for the new module toggle endpoints once audit/event hooks exist.
- [x] Back billing sandbox webhooks with queue-backed retries/metrics.

## Recommended Follow-Ups
1. **Migrations**: Roll out `002_tenant_registrations` across environments and scrub any references to the retired patch script.
2. **Ops Dashboards**: Wire Grafana panels to the module toggle analytics endpoint and audit feed so adoption trends are visible outside the portal.
3. **Portal Location Management**: CRUD + inventory/menu assignment flows ship via `/v1/portal/locations` + `/v1/portal/locations/:locationId/assignments` with per-user location scopes enforced in both API + UI, and the reporting widgets/Csv exports now honor the same scoped filters; next up is layering those guardrails onto upcoming write flows (menu edits, inventory adjustments, POS tickets) and richer analytics.
4. **Feature Flags in UI**: Advanced reporting cards respect the `advanced_reporting` feature flag (rendering additional insights when enabled); continue threading the remaining flags (multi-location scoping, offline POS, etc.) so every control aligns with backend entitlements.
5. **Testing Coverage**: Continue broadening Playwright coverage (POS/menu workflows, disabled-module scenarios, signup->approval) so TESTPLAN flows stay enforced before staging demos.
6. **Entitlement Drills**: Execute plan swap/cancellation/replay drills in each environment using `pnpm drill:billing`, capturing dashboards + alert outputs and refining remediation SOPs (local + staging ready; production drills deferred until a managed cluster exists).

