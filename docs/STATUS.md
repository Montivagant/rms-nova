# Nova RMS Status - 2025-11-17T12:00Z

## Current Snapshot
- **Identity & RBAC**: Registration submission/list/approval, authentication, and role APIs remain stable. Approval wraps `tenant_business_profiles` inserts in a savepoint so unmigrated databases log a warning instead of crashing, and the module-registry JSON is fixed so Fastify boots cleanly. Superadmin UI + Playwright smoke continue to cover rejection and toggle flows.
- **Testing & Coverage**: `pnpm lint`, `pnpm typecheck`, `pnpm test`, `pnpm test:integration`, and `pnpm build` pass locally. Integration tests now auto-run pending migrations via `tests/helpers/ensure-migrations.ts` (skippable with `SKIP_AUTO_MIGRATE=true`), holding the 60/50/70/60 gates en route to TESTPLAN targets.
- **Database & Data Flows**: Forward-only migrations remain the source of truth. `009_portal_account_profiles` created `tenant_business_profiles`; `010_pos_payment_metadata` added processor/refund metadata + `pos_payment_refunds`; `011_loyalty` introduced loyalty accounts/transactions/rules; `012_inventory_count_enhancements` added notes/timestamps/attachment hooks to counts and movements. Billing webhooks persist to `billing_webhook_events`, entitlements sync via the worker, and schema docs live in `docs/DB_SCHEMA.md` + `db/schema.er.mmd`.
- **Customer Portal**: Next 16 / React 19 across dashboard/menu/inventory/POS/payments/reporting/locations/account. `/account` and inventory adjustments/audit log now hit live APIs; `/inventory/reconcile` drives live `/v1/portal/inventory/counts/**` to sync stock and emit audit entries, and each session now exposes both CSV evidence and attachment slots so operators can link photos/signed sheets without leaving the portal. POS quick sales persist processor/tender metadata and now surface inline refund controls on the payments table that call `/v1/portal/pos/payments/:paymentId/refunds` with the same location/RBAC guardrails; the form disables itself automatically when a payment is unsettled or already fully refunded. Payment sandbox stubs now emit status/failure metadata and can simulate pending/failed outcomes via env flags while real provider integration is still pending; loyalty and deep payment settlement still fall back to deterministic mock responses until real integrations land. The loyalty APIs (`/v1/portal/loyalty/overview`, `/loyalty/accounts/:accountId`, `/loyalty/earn`, `/loyalty/redeem`) now back a `/loyalty` workspace in the portal so operators can review balances, inspect transactions, and grant/redeem points with deterministic sample data + Playwright/unit coverage.
- **Payments Sandbox / Provider**: The API now talks to a standalone sandbox service (`pnpm dev:payments-sandbox`) via `PAYMENT_PROVIDER_SANDBOX_BASE_URL`/`PAYMENT_PROVIDER_SANDBOX_API_KEY`, so capture/refund calls leave the API over HTTP and settlement webhooks bounce back into `/v1/portal/pos/payments/:paymentId/status` using `PAYMENT_PROVIDER_WEBHOOK_SECRET`. When the sandbox is offline, the provider client logs a warning and falls back to the deterministic mock for quick dev iteration. Set `PAYMENT_PROVIDER_MODE=real_provider` (with `PAYMENT_PROVIDER_BASE_URL`/`PAYMENT_PROVIDER_API_KEY`) to hit a real gateway; the same webhook + fallback logic applies to that path.
- **Superadmin Portal**: Decision modal, onboarding checklist stub, module toggles with optimistic updates/success toasts, analytics windows, and billing drill-downs are live. `/v1/**` rewrites keep calls on `http://localhost:3000` in dev with graceful fallbacks when the API is offline.
- **Observability & Workers**: Structured logging, Prometheus metrics (`nova_api_superadmin_module_toggle_total`, `nova_api_billing_*`, `nova_api_billing_webhook_total`), audit hooks, Grafana dashboards, and BullMQ billing queues with retry/backoff plus the health server are covered by unit tests.
- **Sample Data & Design System**: `pnpm seed:sample-data` + `@nova/sample-data` power deterministic fallbacks, the mock API, and seeds. Design-system primitives (Button/Input/Textarea/Checkbox/RadioGroup/FormField/Select/etc.) remain canonical and align with the usage guide + Storybook notes.
- **Infrastructure & Environments**: Terraform/Helm overlays target Minikube staging (API + worker images, secrets, probes). Production overlays stay paused per the rollout freeze but are ready once leadership reopens the cluster. Billing drills keep staging evidence fresh (`tests/drills/logs/staging/20251108-204600.md`).
- **Environment Strategy**: Local/staging-first with mock APIs by default; flip to real APIs where they exist (account, inventory, POS quick sale/refunds, counts). This keeps demos unblocked while real persistence is rolled out incrementally.

## Decisions & Principles
- Managed Postgres remains the source of truth; Docker compose is for local bootstrapping only.
- Numbered, forward-only migrations are mandatory; fix-forward scripts add follow-up changes.
- Maintain the 60/50/70/60 coverage gates en route to TESTPLAN targets using deterministic data and real flows whenever possible.

## Active Plan
1. **Payments & POS**: Add a real payment sandbox client (capture/settle/retry), provider-backed refunds, worker jobs/metrics/alerts, and portal UX for live payment states; keep POS RBAC/module toggles authoritative.
2. **Loyalty Delivery**: Portal `/loyalty` workspace plus quick-sale/refund hooks are live; finish expiration logic, additional POS touchpoints, and drills/tests while keeping module registry defaults in sync.
3. **Inventory Reconciliation Evidence**: CSV exports and attachment slots now ship with every count session; next up is richer packaging (multi-file bundles/PDF summaries) and inline previews so ops drills can consume evidence faster.
4. **Playwright & QA**: Expand portal Playwright to account edits, inventory counts, POS sale/refund, and menu create/edit/modifiers (mock + live modes); keep Vitest coverage growing alongside new services.
5. **Ops & Drills**: Add POS/payment/loyalty drill playbooks and staging cadence; keep Terraform/Helm/runbooks aligned with new env vars/secrets for providers/storage.

## Immediate Next Step
- Ship production-ready staging workflows: payment sandbox integration for POS (capture/settlement/refund), polish the new reconciliation attachment workflow with richer exports/previews, wire the new loyalty endpoints into the portal/POS UI (plus expiration + drills), and keep staging billing drills current while adding POS/payment/loyalty drills.

---
---
*Updated by Codex on 2025-11-17T12:00Z.*
